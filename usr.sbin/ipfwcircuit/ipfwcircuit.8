.\" Copyright (c) 2001 Wind River Systems, Inc.  All rights reserved.
.\"
.\"	BSDI	ipfwcircuit.8,v 1.5 2001/10/03 17:29:59 polk Exp
.\"
.\" Copyright (c) 1997 Berkeley Software Design, Inc.
.\" All rights reserved.
.\" The Berkeley Software Design Inc. software License Agreement specifies
.\" the terms and conditions for redistribution.
.\"
.Dd June 16, 1997
.Dt IPFWCIRCUIT 8
.Sh NAME
.Nm ipfwcircuit
.Nd set / delete / modify BSD IP Filter circuit caches
.Sh SYNOPSIS
.Nm ipfwcircuit
.Op Ar filter
.Op Fl Fv
.Op Fl f Ar number
.Op Fl i Ar index
.Op Fl m Ar mask
.Op Fl s Ar size
.Op Fl T Ar tag
.Op Fl w Op Nm src | dst
.Op Fl N Ar maxcircuits
.Op Fl n Ar ticks
.Op Fl t Ar tickrate
.\"
.Nm ipfwcircuit
.Op Ar filter
.Op Fl v
.Op Fl a Ar serial
.Op Fl w Op Nm src | dst
.Op Fl H hitcode
.Op Fl M misscode
.Ar addr1
.Op Ar addr2 
.Ar ports
.\"
.Nm ipfwcircuit
.Op Ar filter
.Op Fl v
.Op Fl d Ar serial
.Op Fl w Op Nm src | dst
.Ar addr1
.Op Ar addr2 
.Ar ports
.\"
.Nm ipfwcircuit
.Op Ar filter
.Op Fl v
.Op Fl D Ar serial
.\"
.Nm ipfwcircuit
.Op Ar filter
.Fl e Ar serial
.Op Fl n Ar ticks
.Op Fl t Ar tickrate
.Sh DESCRIPTION
The
.Nm ipfwcircuit
utility is used to create and maintain circuit caches.
This utility mostly exists for testing purposes.  It is expected
that most real world situations will warrant a custom program
to maintain the circuit cache.
.Pp
The
.Ar filter
argument, if specified, must be one of:
.Bl -tag -width indent
.It Nm pre-input
A filter on all IP packets as they first enter IP processing
.It Nm input
A filter on IP packets destined for the local machine, after fragment
re-assembly.
.It Nm forward
A filter on IP packets being forwarded through this machine.
.It Nm pre-output
A filter on all IP packets leaving this machine, prior to routing.
.It Nm output
A filter on IP packets generated locally by this machine.
.It Nm call
Not an actual filtering point, this chain should contain filters to
be called from a BPF based filter.
This is the default chain of filters used.
.El
.Pp
The following options are available:
.Bl -tag -width indent
.It Fl a
Add an entry to the filter specified by
.Ar serial .
.It Fl D
Display the number of entries in each bucket for the circuit cache
specified by
.Ar serial .
.It Fl d
Delete the entry specified in the circuit cache specified by
.Ar serial .
.It Fl e
Expire old circuits.  In this mode the program does not return but
checks every
.Ar tickrate
seconds for circuits that have not been used in the past
.Ar tick
intervals (or
.Ar tickrate * tick
seconds).
.It Fl F
For TCP circuit caches turn on the following of FIN's and RST's.
.It Fl f
Insert the newly created filter at location
.Ar number
in the call list.
.It Fl H
When used with the
.Fl a
flag specify the return value on a hit
.It Fl i
Specify interface to restrict filtering to.
Currently this must be the interfaces index number.
.It Fl m
Set the mask of the first 32 bits of the data packet to examine
to
.Ar mask .
By default all 32 bits are examined.
.It Fl N
Set the maximum number of circuits allowed in the cache to
.Ar maxcircuits .
.It Fl n
Set the number of ticks before an entry expires.  Defaults to to
128, which is also the maximum value.
.It Fl s
By default all circuit caches have 997 buckets.  This is good for
up to 10,000 entries.  An alternate
.Ar size
my be specified with
.Fl s .
.It Fl T
Specify the
.Ar tag
to be used for this filter.
.It Fl t
Set the tick rate for expiration.  Defaults to 225 seconds per tick.
When combined with a 128 ticks (the default) the expiration rate is
8 hours.
.It Fl v
Be verbose about what is going on.
.It Fl w
By default both the source and destination IP addresses are used.
Specifying
.Nm src
or
.Nm dst
with the
.Fl w
flag will limit the usage to only that entry.
Providing
.Fl w
.Nm src
.Fl w
.Nm dst
allows the insertion of a uni-directional circuit cache using both addresses.
.El
.Pp
If none of
.Fl a ,
.Fl d ,
or
.Fl D
are specified then a new circuit cache is created.
.Pp
When adding or deleting any entry to the circuit cache, the same
.Fl w
flags must be passed as were used in the creation of the filter.
When
.Fl w
is not used
.Ar addr1
and
.Ar addr2
specify the two addresses.
The first 32 bits of data will be treated as two 16 bits words.
If
.Ar addr1
is the destination address of the packet being checked then the
16 bit words will be swapped prior to checking.
Even if the
.Ar mask
is zero,
.Ar ports
must be specified (the pattern to compare the first 32 bits of data
to after masking).
.Sh SEE ALSO
.Xr ipfw 8 ,
.Xr ipfwdump 8 ,
.Xr ipfwlog 8
